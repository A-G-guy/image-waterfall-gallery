# 思源笔记 - 瀑布流画廊插件

[English](README_en.md) | 简体中文

## 📖 插件简介

瀑布流画廊插件为思源笔记提供了沉浸式的图片浏览体验。当您打开带有 `#gallery` 标签的文档时，插件会自动提取文档中的所有图片，并以精美的瀑布流布局全屏展示，让您可以专注于欣赏图片内容，而不受文字干扰。

## ✨ 功能特性

- 🎯 **自动触发**：打开带有 `#gallery` 标签的文档时自动进入画廊模式
- 🖼️ **瀑布流布局**：采用等宽不等高的瀑布流布局，充分利用屏幕空间
- ⚙️ **插件设置**：可配置图片顺序（随机/顺序/倒序）和图片宽度
- 📁 **画廊管理**：统一管理所有画廊文件，支持查看、添加、删除图片
- 🔍 **灯箱效果**：点击图片全屏查看，支持导航和键盘操作
- 🎨 **主题适配**：自动适配思源笔记的深色/浅色主题
- 📱 **响应式设计**：支持桌面端和移动端，自动调整布局
- ⚡ **性能优化**：图片懒加载，提升加载速度
- 🎭 **优雅动画**：淡入动画效果，提供流畅的视觉体验
- ⌨️ **快捷操作**：支持 ESC 键快速退出画廊模式

## 📦 安装方法

### 方法一：集市安装（推荐）

1. 打开思源笔记
2. 进入 `设置` → `集市` → `插件`
3. 搜索 "瀑布流画廊" 或 "Image Waterfall Gallery"
4. 点击 `下载` 并启用插件

### 方法二：手动安装

1. 下载最新版本的 `package.zip`
2. 解压到思源笔记的 `data/plugins/` 目录
3. 重启思源笔记
4. 在 `设置` → `插件` 中启用插件

## 🚀 使用方法

### 基础使用

1. 创建或打开一个包含图片的文档
2. 为文档添加 `#gallery` 标签
   - 点击文档标题右侧的 `...` 菜单
   - 选择 `属性` → `标签`
   - 输入 `gallery` 并保存
3. 切换到该文档时，插件会自动进入画廊模式

### 退出画廊模式

- 按 `ESC` 键
- 点击右上角的关闭按钮 `✕`

### 灯箱查看

- 在画廊模式下，点击任意图片可进入灯箱全屏查看
- 使用左右导航按钮或键盘 `←` `→` 键切换图片
- 按 `ESC` 键或点击背景关闭灯箱

### 插件设置

1. 进入 `设置` → `插件` → `瀑布流画廊` → `设置`
2. 可配置以下选项：
   - **图片顺序**：
     - 随机顺序（默认）：每次打开文档时随机排列图片
     - 顺序：按文档中的原始顺序显示
     - 倒序：按文档中的倒序显示
   - **图片宽度**：
     - 范围：200-600 像素
     - 默认值：移动端 300px，桌面端 350px
     - 调整宽度会影响瀑布流的列数

### 画廊文件管理

1. 进入 `设置` → `插件` → `瀑布流画廊` → `设置`
2. 点击 `管理画廊文件` 按钮
3. 在画廊管理界面中：
   - **查看所有画廊**：显示所有带有 `#gallery` 标签的文档
   - **排序方式**：支持按创建日期（倒序/正序）或引用顺序排序
   - **进入单个画廊**：点击 `管理` 按钮查看单个画廊的详细信息
4. 在单个画廊管理界面中：
   - **查看图片**：以网格形式展示所有图片及其详细信息
   - **添加图片**：点击 `+ 添加图片` 按钮，输入图片路径或URL
   - **删除图片**：点击图片下方的 `删除` 按钮（仅删除引用，不删除附件）
   - **查看大图**：点击图片可在灯箱中查看
   - **返回列表**：点击 `← 返回` 按钮返回画廊列表

### 使用场景

- 📸 **摄影作品集**：展示您的摄影作品
- 🎨 **设计灵感库**：收集和浏览设计灵感
- 🖼️ **艺术画廊**：欣赏艺术作品
- 📚 **图片笔记**：浏览图片密集型笔记

## 🎬 效果预览

![预览图](preview.png)

## ⚙️ 技术架构

### 核心技术

- **监听机制**：使用 `eventBus.on("switch-protyle")` 监听文档切换
- **数据查询**：通过 SQL API 查询文档标签和图片
  - 标签检测：查询 `blocks` 表的 `tag` 字段
  - 图片提取：查询 `spans` 表中 `type='img'` 的行内元素
- **布局方案**：CSS Multi-column 实现纯 CSS 瀑布流
- **主题适配**：使用思源 CSS 变量（如 `var(--b3-theme-background)`）

### 文件结构

```text
image-waterfall-gallery/
├── src/
│   ├── index.ts          # 核心逻辑
│   └── index.scss        # 样式文件
├── plugin.json           # 插件配置
├── icon.png             # 插件图标
└── README.md            # 说明文档
```

## 🔧 开发说明

### 环境要求

- Node.js >= 16
- pnpm 或 npm

### 开发步骤

```bash
# 安装依赖
npm install

# 开发模式
npm run dev

# 生产构建
npm run build
```

### 构建产物

- `dist/index.js` - 主程序
- `dist/index.css` - 样式文件
- `package.zip` - 插件包

## 📝 更新日志

### v1.0.3 (2025-12-24)

- ✨ **新增画廊文件管理功能**：统一管理所有画廊文件
  - 自动发现所有带有 `#gallery` 标签的文档
  - 支持多种排序方式：创建日期（倒序/正序）、引用顺序
  - 单个画廊详细管理：查看所有图片及详细信息
  - 快捷添加图片：通过URL或路径添加新图片
  - 快捷删除图片：删除图片引用（保留附件文件）
  - 图片预览：点击图片可在灯箱中查看
- 🔧 **改进图片加载**：
  - 添加加载状态指示器
  - 添加错误处理和提示
  - 移除懒加载以提升响应速度
- ⚠️ **已知问题**：
  - 画廊管理界面中图片可能无法正常显示，正在调查中

### v1.0.2 (2025-12-24)

- ✨ **新增插件设置功能**：支持配置图片顺序和宽度
  - 图片顺序：随机（默认）、顺序、倒序
  - 图片宽度：200-600像素可调，支持平台自适应默认值
- ✨ **新增灯箱效果**：点击图片可全屏查看
  - 支持上一张/下一张导航按钮
  - 支持键盘快捷键（ESC关闭，←→切换）
  - 显示图片计数器（如 "3 / 10"）
- 🔧 **改进跨平台兼容性**：
  - 使用 `column-width` 替代固定 `column-count`，提升响应式效果
  - 添加平台检测，移动端和桌面端使用不同默认宽度
  - 优化移动端触控体验

### v1.0.1 (2025-12-24)

- 🐛 **修复标签检测错误**：修正 SQL 查询，从 `attributes` 表改为 `blocks` 表的 `tag` 字段
- 🐛 **修复图片提取错误**：修正 SQL 查询，从 `blocks` 表改为 `spans` 表查询 `type='img'` 的图片元素
- 🐛 **修复 API 调用错误**：使用 `fetchSyncPost` 替代 `fetchPost`，解决插件无法启用的问题
- 🔧 **增强调试功能**：添加详细的调试日志，便于问题排查

### v1.0.0 (2025-12-23)

- 🎉 首次发布
- ✨ 实现自动瀑布流画廊功能
- 🎨 支持主题适配
- 📱 支持响应式布局
- ⚡ 图片懒加载优化

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License

## 🙏 致谢

感谢思源笔记团队提供的优秀平台和完善的插件 API。

---

**提示**：如果您喜欢这个插件，欢迎给个 ⭐ Star！
